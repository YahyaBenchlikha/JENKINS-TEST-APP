name: Deploy

on:
  workflow_call:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build application
      run: mvn clean package -DskipTests

    - name: Build Docker image
      run: |
        echo "FROM eclipse-temurin:17-jre
        COPY target/*.jar app.jar
        EXPOSE 7777
        ENTRYPOINT [\"java\", \"-jar\", \"/app.jar\"]" > Dockerfile
        docker build -t jenkins-test-app:${{ github.sha }} .

    - name: Run application
      run: |
        docker run -d -p 7777:7777 --name jenkins-test-app jenkins-test-app:${{ github.sha }}

    - name: Wait for application to start
      run: |
        echo "Waiting for application to start..."
        for i in {1..60}; do
          if curl -f http://localhost:7777/actuator/health > /dev/null 2>&1; then
            echo "Application is ready!"
            break
          fi
          echo "Attempt $i/60 - waiting 5 seconds..."
          sleep 5
        done

    - name: Health check
      run: |
        echo "Final health check..."
        curl -f http://localhost:7777/actuator/health || {
          echo "Health check failed. Checking container logs:"
          docker logs jenkins-test-app
          exit 1
        }

    - name: Stop application
      if: always()
      run: |
        docker stop jenkins-test-app || true
        docker rm jenkins-test-app || true

    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        echo "Application deployed successfully with image: jenkins-test-app:${{ github.sha }}"